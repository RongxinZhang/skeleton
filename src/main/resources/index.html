<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        html, body, div{
          -webkit-font-smoothing: antialiased;
          line-height: 1.5em;
          font: 16px Helvetica, arial, sans-serif;
          margin: 0px;
          padding: 0px;
          box-sizing: border-box;
        }

        #container {
          border: 1px solid brown;
          max-width: 600px;
          margin: 100px auto
        }
        H1 {
          float: left;
        }

        /*Buttons*/
        .button{
            background-color:#55A;
            border-radius: 3px;
            width: 100px;
            float: right;
            padding: 15px;
            text-transform: uppercase;
            font-size: 13px;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        #add-receipt{
          margin: 15px 0px;
        }

        #add-receipt-modal .button{
          margin-top: 15px;
        }

        #cancel-receipt{
          margin-right: 15px;
        }

        /*MODAL*/
        #add-receipt-modal{
            float: left;
            padding: 30px;
            width: 100%;
            background: orange;
            margin: 0 0 15px 0;
            display: none;
        }

        input {
          border-radius: 3px;
        }

        #add-receipt-modal input{
            width: 100%;
            box-sizing: border-box;
            padding: 15px;
            font-size: 15px;
            border: 0px;
        }

        #add-receipt-modal #amount{
          margin-top: 15px;
        }

        #receiptList {
            border: 1px solid green;
            clear: both;
            min-height: 500px;
        }

        .receipt {
            /*background-color: #333;*/
            margin-bottom: 5px;
            display: table;
            width: 100%;
            /*height: 100px;*/
        }

        .cells {
          display: table-cell;
          vertical-align: top;
          margin-right: -5px;
          border: 1px solid black;
          background: #f1f1f1;
          width: 25%;
          height: 100%;
          padding: 15px;
          text-align: left;
        }

        /*Column headers*/
        #col-header{
          display: table;
          width: 100%
        }

        #col-header .cells{
          background: grey;
        }

        .row{
          display: table-row;
        }

        /*Tags*/
        .tag-items{
          background: violet;
          color white;
          text-align: center;
          padding: 10px;
          border-radius: 100px;
          text-transform: uppercase;
          font-size: 13px;
          font-weight: 600;
          color: white;
          margin-bottom: 10px;
        }

        .add-tag{
          margin: 0px;
          background: grey;
        }

        .add-tag-row{
          caption-side: bottom;
          display: table-caption;
          padding: 15px;
          background: grey;
          display: none;
        }

        .tag_input{
          width: 100%;
          padding: 15px;
          font-size: 15px;
          border: 0px;
          box-sizing: border-box;
        }


    </style>
</head>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <div class="button" id="add-receipt">+</div>

    <div id="add-receipt-modal">
      <input type="text" name="merchant" placeholder="merchant" id="merchant">
      <input type="text" name="amount" placeholder="amount" id="amount">
      <div id="response"></div>
      <div class="button" id="save-receipt">save</div>
      <div class="button" id="cancel-receipt">cancel</div>
    </div>

    <!-- Column headers -->
    <div id="col-header">
      <div class="cells time">Time</div>
      <div class="cells merhant">Merchant</div>
      <div class="cells dollar">$</div>
      <div class="cells tags">tags</div>
    </div>
    <div id="receiptList">

      <!-- TEMPLATE START -->
      <!-- <div class="receipt">
        <div class="row">
          <div class="cells time">1s ago</div>
          <div class="cells merchant">Jerry's Ice Cream</div>
          <div class="cells amount">4000</div>
          <div class="cells tags">
            <div class="tagValue tag-items"> bob </div>
            <div class="add-tag tag-items"> add + </div>
          </div>
        </div>

        <div class="add-tag-row">
          <input type="text" name="tag_input" placeholder="tag name" class="tag_input">
        </div>
      </div> -->
      <!-- TEMPLATE END -->
    </div>
</DIV>
</body>

<script>
    // This is the idiomatic way to ensure that JQuery does not
    // execute until the page has loaded
    // r = {
    //     "id": 1,
    //     "merchantName": "money",
    //     "value": 10,
    //     "tags": "man",
    //     "created": "21:26:04"
    // }

    $(function(){

        /*
        * Ajax requests
        */

        // const api = "localhost:8080"; // <- do not need a root api URL if this page is served directly by the API

        function getAllReceipts(cb){
          $.getJSON("/receipts", function(receipts){
            cb(receipts)
          })
        }

        function putReceipt(info, cb){
          $.ajax({ method: "POST", url: "/receipts", 'dataType': 'json',  headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
            data: JSON.stringify({ merchant: info.merchant, amount: info.amount })
          }).done(function( msg ) {
            console.log(msg);
            cb(msg)
          });
        };

        /*
        * Receipt
        */

        // Show receipt
        $("#add-receipt").click(() =>{
          $("#add-receipt-modal").toggle()
        })

        $("#cancel-receipt").click(() =>{
          $("#add-receipt-modal").toggle()
        })

        $("#save-receipt").click(() =>{
          merchant = $("#merchant").val()
          amount = $("#amount").val()
          // console.log(name, amount);
          putReceipt({merchant: merchant, amount: amount}, (res)=>{
            if (res){
              getAllReceipts((r)=>{
                // for (var i = 0; i < r.length; i++) {

                last = r.length - 1
                tags = []
                // console.log(r[i].tags);
                if (r[last].tags && r[last].tags.length > last) tags = r[last].tags.length.split(" ")
                createReceipt(r[last].created, r[last].merchantName, r[last].value, tags)
                // }
              })
            } else {
              print(res)
              $("#response").text(res)
            }
          })
          // PUT and get respomnse
        })

        /*
        * Create Receipts
        */



        function createReceipt(time, merchantName, amount, tags){
          template = '<div class="receipt"> <div class="row"> <div class="cells time">' +
          time + '</div> <div class="cells merchant">' +
          merchantName + '</div> <div class="cells amount">' +
          amount + '</div> <div class="cells tags">' +
          createTags(tags) + '<div class="add-tag tag-items"> add \+ </div> </div> </div> <div class="add-tag-row"> <input type="text" name="tag_input" placeholder="tag name" class="tag_input"> </div> </div>'

          $(template).appendTo($('#receiptList'))
        }

        function createTags(tags){
          template = ""
          if (tags.length > 0){
            for(i = 0; i < tags.length; i++){
              template += '<div class="tagValue tag-items">' + tags[i] + '</div>'
            }
          }
          return template
        }
    })
</script>

</html>
